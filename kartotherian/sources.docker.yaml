# Generates vtiles from database
genraw:
  public: true
  formats: [pbf]
  uri: tmsource://
  yaml:
    npm: ["@kartotherian/osm-bright-source", "data.yml"]
  yamlSetDataSource:
    if:
      dbname: gis
      host: ''
      type: postgis
    set:
      host: { var: osmdb-host }
      port: { var: osmdb-port }
      user: {var: osmdb-user}
      password: {var: osmdb-pswd}
# expand name_ attributes into individual tags
gen:
  uri: json2tags://
  params:
    source: {ref: genraw}

# Tegola backend
http-tegola:
  uri: http://tegola:8080/maps/osm/{z}/{x}/{y}.pbf
  setInfo:
    vector_layers:
      - id: landuse
      - id: waterway
      - id: water
      - id: aeroway
      - id: building
      - id: road
      - id: admin
      - id: country_label
      - id: place_label
      - id: poi_label
      - id: road_label

# Tegola beta-cluster backend
beta-cluster-http-tegola:
  uri: https://tegola.wmflabs.org/maps/osm/{z}/{x}/{y}.pbf
  setInfo:
    vector_layers:
      - id: landuse
      - id: waterway
      - id: water
      - id: aeroway
      - id: building
      - id: road
      - id: admin
      - id: country_label
      - id: place_label
      - id: poi_label
      - id: road_label

# Cassandra storage
v4:
  public: true
  formats: [pbf]
  uri: cassandra://
  params:
    maxzoom: 16
    keyspace: v4
    cp: {var: cassandra-servers}
    username: {var: cassandra-user}
    password: {var: cassandra-pswd}
    repfactor: 1
    durablewrite: 0
    createIfMissing: true
    copyInfoFrom: {ref: gen}
    setLastModified: true

# set name tag based on name_* attributes
genviewraw:
  uri: babel://
  params:
    source: {ref: gen}
    tag: name
    combineName: true
    defaultLanguage: en

# View tiles as generated directly from the database. Don't view zoom0-5
genview:
  public: true
  formats: [png,json,headers,svg,jpeg]
  scales: [1.3, 1.5, 2, 2.6, 3]
  static: true
  maxheight: 2048
  maxwidth: 2048
  uri: tmstyle://
  yaml:
    npm: ["@kartotherian/osm-bright-style", "project.yml"]
  yamlSetParams:
    source: {ref: genviewraw}
  defaultHeaders:
    Cache-Control: 'no-cache, no-store, must-revalidate'
    Pragma: no-cache
    Expires: 0

# Default OSM PBF source
osm-pbf:
  public: true
  formats: [pbf]
  uri: overzoom://
  params:
#    source: {ref: http-tegola}
#    source: {ref: beta-cluster-http-tegola}
    source: { ref: v4 }
    maxzoom: 19
  overrideInfo:
    attribution: 'Map data © <a href="http://openstreetmap.org/copyright">OpenStreetMap contributors</a>'
    tiles: ["http://localhost:6533/osm-pbf-tegola/{z}/{x}/{y}.pbf"]

babel:
  uri: babel://
  params:
    source: {ref: osm-pbf}
    tag: name
    combineName: false
    defaultLanguage: local

# OSM map with international labeling
osm-intl:
  public: true
  formats: [png,json,headers,svg,jpeg]
  scales: [1.3, 1.5, 2, 2.6, 3]
  maxzoom: 19
  static: true
  maxheight: 2048
  maxwidth: 2048
  uri: tmstyle://
  yaml:
    npm: ["@kartotherian/osm-bright-style", "project.yml"]
  yamlSetParams:
    source: {ref: babel}
  overrideInfo:
    attribution: 'Map data © <a href="http://openstreetmap.org/copyright">OpenStreetMap contributors</a>'
    tiles: ["http://localhost:6533/osm-intl/{z}/{x}/{y}.png"]
  defaultHeaders:
    Cache-Control: 'no-cache, no-store, must-revalidate'
    Pragma: no-cache
    Expires: 0

# OSM map without any labels
osm:
  public: true
  formats: [png,json,headers,svg,jpeg]
  scales: [1.3, 1.5, 2, 2.6, 3]
  maxzoom: 19
  static: true
  maxheight: 2048
  maxwidth: 2048
  uri: tmstyle://
  yaml:
    npm: ["@kartotherian/osm-bright-style", "project.yml"]
  yamlSetParams:
    source: {ref: osm-pbf}
  yamlExceptLayers: ['country_label', 'place_label', 'poi_label']
  overrideInfo:
    attribution: 'Map data © <a href="http://openstreetmap.org/copyright">OpenStreetMap contributors</a>'
    tiles: ["http://localhost:6533/osm/{z}/{x}/{y}.png"]
